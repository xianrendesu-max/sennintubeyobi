<!DOCTYPE html>
<html lang="ja">
<head>
    <title>{{ videotitle }} - ä»™äººtube</title>
    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/css/grids-responsive-min.css">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
    body {
        margin: 0;
        background: #f9fafb;
        font-family: "Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;
        color: #0f172a;
    }

    a { text-decoration: none; color: inherit; }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .main-grid {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 24px;
    }

    @media (max-width: 900px) {
        .main-grid { grid-template-columns: 1fr; }
    }

    .player-wrapper video {
        width: 100%;
        background: black;
        border-radius: 14px;
    }

    .video-title {
        font-size: 20px;
        font-weight: 600;
        margin: 12px 0;
    }

    .channel-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 12px 0;
    }

    .channel-row img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
    }

    .actions {
        display: flex;
        gap: 10px;
        margin: 12px 0;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
    }

    .action-btn.primary {
        background: #2563eb;
        color: white;
        border: none;
    }

    .description {
        background: #f1f5f9;
        border-radius: 12px;
        padding: 14px;
        font-size: 14px;
        line-height: 1.6;
    }

    .option-box {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .option-box select,
    .option-box button {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
    }

    .related {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .related-item {
        display: flex;
        gap: 10px;
    }

    .related-thumb {
        width: 160px;
        aspect-ratio: 16 / 9;
        border-radius: 10px;
        overflow: hidden;
    }

    .related-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-error-alert {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: #ef4444;
        color: white;
        padding: 12px 40px 12px 20px;
        border-radius: 12px;
        font-size: 14px;
        opacity: 0;
        pointer-events: auto;
        animation: slideFade 0.4s ease forwards;
        z-index: 10;
    }

    .video-error-alert .close-btn {
        position: absolute;
        top: 6px;
        right: 10px;
        font-size: 18px;
        cursor: pointer;
        line-height: 1;
        opacity: 0.8;
    }

    .video-error-alert .close-btn:hover {
        opacity: 1;
    }

    @keyframes slideFade {
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    .loading-overlay{
        position:absolute;
        inset:0;
        background:rgba(0,0,0,.55);
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:6;
        border-radius:14px;
    }

    .spinner{
        width:48px;
        height:48px;
        border:4px solid rgba(255,255,255,.3);
        border-top-color:#fff;
        border-radius:50%;
        animation:spin 1s linear infinite;
    }

    @keyframes spin{
        to{ transform:rotate(360deg); }
    }
</style>
</head>

<body>
{% include "base.html" %}

<div class="container">
<div class="main-grid">

<div>
<div class="player-wrapper" style="position:relative">
    <div id="videoError" class="video-error-alert" style="display:none">
        âš  å‹•ç”»ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®å†ç”Ÿæ–¹æ³•ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
        <span class="close-btn" onclick="hideVideoError()">Ã—</span>
    </div>

    <div id="loading" class="loading-overlay" style="display:none">
        <div class="spinner"></div>
    </div>

    <video id="videoPlayer" controls
        poster="https://img.youtube.com/vi/{{ videoid }}/0.jpg">
    </video>
</div>

<div class="video-title">{{ videotitle }}</div>

<div class="channel-row">
    <a href="/channel/{{authorid}}">
        <img src="{{authoricon}}">
    </a>
    <div>{{ author }}</div>
</div>

<div class="actions">
    <a class="action-btn primary" href="{{ videourls[0] }}" target="_blank">â¬‡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
</div>

<div class="description">
{{ description | safe }}

<div class="option-box">
    <select id="qualitySelect">
        <option value="0">é«˜ç”»è³ª</option>
        <option value="1">ä½ç”»è³ª</option>
    </select>
</div>
</div>

<div class="option-box">
    <button onclick="setMode('nocookie')">nocookieå†ç”Ÿ</button>
    <button onclick="setMode('stream')">streamå†ç”Ÿ</button>
    <button onclick="retryVideo()">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>

    <select id="backendSelect">
        <option value="main">main</option>
        <option value="yobi">yobi</option>
        <option value="yobiyobi">yobiyobi</option>
        <option value="wkt">wkt</option>
    </select>
</div>

<div style="margin-top:24px">
    <iframe src="/comments?v={{ videoid }}"
        style="width:100%;border:none;min-height:600px">
    </iframe>
</div>
</div>

<div class="related">
{% for re in res %}
<a href="/watch?v={{ re['id'] }}" class="related-item">
    <div class="related-thumb">
        <img src="https://img.youtube.com/vi/{{ re['id'] }}/0.jpg">
    </div>
    <div>
        <div>{{ re["title"] }}</div>
        <div style="font-size:12px;color:#64748b">{{ re["author"] }}</div>
    </div>
</a>
{% endfor %}
</div>

</div>
</div>

<script>
const urls = {{ videourls | tojson }};
const dash = {{ dash | tojson }};
const video = document.getElementById("videoPlayer");
const backendSelect = document.getElementById("backendSelect");
const qualitySelect = document.getElementById("qualitySelect");
const errorAlert = document.getElementById("videoError");
const loading = document.getElementById("loading");

let dashPlayer = null;
let hlsPlayer = null;

function showLoading(){ if(loading) loading.style.display="flex"; }
function hideLoading(){ if(loading) loading.style.display="none"; }

function showVideoError(){
    errorAlert.style.display = "block";
    errorAlert.style.animation = "none";
    errorAlert.offsetHeight;
    errorAlert.style.animation = null;
}

function hideVideoError(){
    errorAlert.style.display = "none";
}

video.onerror = showVideoError;

function getStreamBase(){
    if (backendSelect.value === "yobi") return "/api/streamurl/yobi";
    if (backendSelect.value === "yobiyobi") return "/api/streamurl/yobiyobi";
    return "/api/streamurl";
}

video.src = urls[1] || urls[0];
</script>

<script>
function watchPlayback(video, timeout = 5000){
    let resolved = false;
    showLoading();

    const success = ()=>{
        resolved = true;
        hideLoading();
    };

    const fail = (reason)=>{
        if(resolved) return;
        resolved = true;
        hideLoading();
        showVideoErrorWithReason(reason);
    };

    setTimeout(()=>{
        if(!resolved){
            if(video.videoWidth === 0){
                fail("video");
            }else{
                fail("timeout");
            }
        }
    }, timeout);

    video.addEventListener("playing", success, { once:true });
    video.addEventListener("canplay", success, { once:true });
    video.addEventListener("error", ()=>fail("video"), { once:true });
    video.addEventListener("stalled", ()=>fail("stalled"), { once:true });

    video.addEventListener("waiting", ()=>{
        setTimeout(()=>{
            if(video.readyState < 3){
                fail("waiting");
            }
        },3000);
    }, { once:true });
}
</script>

<script>
function showVideoErrorWithReason(reason){
    const messages = {
        video: "âš  å‹•ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
        stalled: "âš  å†ç”ŸãŒåœæ­¢ã—ã¾ã—ãŸã€‚",
        waiting: "âš  èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã›ã‚“ã€‚",
        timeout: "âš  å†ç”ŸãŒé–‹å§‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
    };

    errorAlert.innerHTML =
        (messages[reason] || "âš  ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚") +
        ' <button onclick="retryVideo()" style="margin-left:10px;padding:4px 10px;border-radius:999px;border:none;cursor:pointer">å†è©¦è¡Œ</button>' +
        '<span class="close-btn" onclick="hideVideoError()">Ã—</span>';

    showVideoError();
}
</script>

<script>
function retryVideo(){
    hideVideoError();
    const v = document.getElementById("videoPlayer");
    if(v){
        showLoading();
        v.load();
        watchPlayback(v);
    }
}
</script>

<!-- â˜… yobiyobi é¸æŠæ™‚ã¯å¾“æ¥å†ç”Ÿï¼‹nocookieå¯ -->
<script>
function applyStream(){
    if(backendSelect.value === "yobiyobi"){
        hideVideoError();
        showLoading();
        video.pause();
        video.src = urls[1] || urls[0];
        video.load();
        watchPlayback(video);
        return;
    }

    const base = getStreamBase();
    const q = qualitySelect.value === "0" ? "best" : "low";
    const url = base + "?video_id={{ videoid }}&quality=" + q;

    hideVideoError();
    showLoading();

    video.pause();
    video.src = url;
    video.load();
    watchPlayback(video);
}

backendSelect.addEventListener("change", applyStream);
qualitySelect.addEventListener("change", applyStream);
</script>

</body>
</html>
