{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Shorts - ä»™äººtube</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #000;
    overflow: hidden;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

/* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity .3s ease;
}

.spinner {
    width: 42px;
    height: 42px;
    border: 4px solid #333;
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== ã‚¨ãƒ©ãƒ¼ ===== */
.error-alert {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.85);
    color: #fff;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn .3s ease;
}

.error-box {
    text-align: center;
}

.error-box button {
    margin-top: 14px;
    padding: 6px 14px;
    border: none;
    background: #fff;
    color: #000;
    border-radius: 4px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(.95); }
    to { opacity: 1; transform: scale(1); }
}

/* ===== å…¨ä½“ ===== */
.shorts-container {
    height: 100vh;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    scroll-behavior: smooth;
}

/* ===== 1ã‚·ãƒ§ãƒ¼ãƒˆ ===== */
.short-item {
    position: relative;
    height: 100vh;
    scroll-snap-align: start;
    background: #000;
    will-change: transform;
}

/* ===== å‹•ç”» ===== */
.short-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ===== å³å´UI ===== */
.short-actions {
    position: absolute;
    right: 12px;
    bottom: 110px;
    display: flex;
    flex-direction: column;
    gap: 22px;
    align-items: center;
    color: #fff;
    transition: transform .25s ease, opacity .25s ease;
}

.short-action {
    font-size: 12px;
    text-align: center;
}

.short-action span {
    font-size: 28px;
    display: block;
}

/* ===== ä¸‹æƒ…å ± ===== */
.short-info {
    position: absolute;
    left: 14px;
    bottom: 24px;
    right: 90px;
    color: #fff;
    transition: transform .25s ease, opacity .25s ease;
}

.short-channel {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
}

.short-channel-name {
    font-weight: 600;
    font-size: 14px;
}

.subscribe-btn {
    background: #fff;
    color: #000;
    border: none;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
}

.subscribe-btn.subscribed {
    background: #333;
    color: #fff;
}

/* ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º ===== */
.shorts-container::-webkit-scrollbar {
    display: none;
}
</style>
</head>

<body>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
</div>

<div class="error-alert" id="errorAlert">
    <div class="error-box">
        <div>å‹•ç”»ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>
        <button onclick="location.reload()">å†èª­ã¿è¾¼ã¿</button>
    </div>
</div>

<div class="shorts-container" id="shortsContainer">

<!-- â˜… å˜ä½“Shortå¯¾å¿œï¼ˆã“ã“ã ã‘å¤‰æ›´ï¼‰ -->
<div class="short-item">
    <video class="short-video"
           src="{{ hls_url }}"
           autoplay
           muted
           loop
           playsinline></video>

    <div class="short-actions">
        <div class="short-action like-btn">
            <span>â¤ï¸</span>
            <div></div>
        </div>
        <div class="short-action">
            <span>ğŸ’¬</span>
            <div></div>
        </div>
        <div class="short-action">
            <span>â†—</span>
            <div>å…±æœ‰</div>
        </div>
    </div>

    <div class="short-info">
        <div class="short-channel">
            <div class="short-channel-name">@{{ author }}</div>
            <button class="subscribe-btn" data-channel="{{ authorid }}">
                ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²
            </button>
        </div>
        <div class="short-title">{{ title }}</div>
    </div>
</div>

</div>

<script>
const container = document.getElementById("shortsContainer");
const loading = document.getElementById("loading");
const errorAlert = document.getElementById("errorAlert");

/* ===== èª­ã¿è¾¼ã¿åˆ¶å¾¡ ===== */
let loaded = false;
document.querySelectorAll(".short-video").forEach(v => {
    v.addEventListener("canplay", () => {
        if (!loaded) {
            loaded = true;
            loading.style.opacity = 0;
            setTimeout(() => loading.remove(), 300);
        }
    });
    v.addEventListener("error", () => {
        loading.remove();
        errorAlert.style.display = "flex";
    });
});

/* ===== å†ç”Ÿåˆ¶å¾¡ ===== */
function updatePlay() {
    document.querySelectorAll(".short-video").forEach(v => {
        const r = v.getBoundingClientRect();
        if (r.top >= -50 && r.bottom <= window.innerHeight + 50) {
            v.play();
        } else {
            v.pause();
        }
    });
}
container.addEventListener("scroll", updatePlay);
updatePlay();

/* ===== ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­UIè¿½å¾“ ===== */
container.addEventListener("scroll", () => {
    document.querySelectorAll(".short-item").forEach(item => {
        const rect = item.getBoundingClientRect();
        const progress = Math.min(Math.abs(rect.top) / window.innerHeight, 1);
        item.querySelector(".short-actions").style.opacity = 1 - progress;
        item.querySelector(".short-info").style.opacity = 1 - progress;
    });
});

/* ===== ã‚¿ãƒƒãƒ—æ“ä½œ ===== */
document.querySelectorAll(".short-video").forEach(v => {
    v.addEventListener("click", () => v.muted = !v.muted);
});

/* ===== æˆ»ã‚‹ã‚¹ãƒ¯ã‚¤ãƒ— ===== */
let startX = 0, startY = 0;
document.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
});
document.addEventListener("touchend", e => {
    const dx = e.changedTouches[0].clientX - startX;
    const dy = Math.abs(e.changedTouches[0].clientY - startY);
    if (startX < 40 && dx > 120 && dy < 80) history.back();
});
</script>

</body>
</html>
{% endblock %}
